apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: frugalia-zombie-lb
  namespace: monitoring
  labels:
    release: prometheus
    app: frugalia-mcp
spec:
  groups:
  - name: frugalia.zombie_lb
    interval: 30s
    rules:
    # Alert: Delete Loadbalancers without endpoints
    - alert: AutoDeleteZombieLoadBalancer
      expr: |
        label_replace(kube_service_spec_type{type="LoadBalancer"}, "endpoint", "$1", "service", "(.*)")
        unless on(namespace, endpoint)
        kube_endpoint_address
      for: 2m
      labels:
        severity: critical
        component: frugalia-agent
        mode: autonomous
      annotations:
        summary: "LoadBalancer with no backends in {{ $labels.namespace }}"
        description: "Service {{ $labels.service }} in {{ $labels.namespace }} is type LoadBalancer but has no backend endpoints. Cost: ~$20/month."
        action: |
          MODE: AUTONOMOUS (NO USER CONFIRMATION).
          Context: Service '{{ $labels.service }}' in '{{ $labels.namespace }}' is a zombie LoadBalancer.
          Cluster: frugalia-demo. Slack Channel: #frugalia
          
          TASK:
          1. Delete LB and notify Slack with detailed optimization report